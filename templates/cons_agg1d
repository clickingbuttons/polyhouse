CREATE TABLE {{ .database }}.{{ .table }} (
  ts     Date32,
  {{ .aggFields }}
)
ENGINE = ReplacingMergeTree()
PARTITION BY toYear(ts)
ORDER BY (ticker, ts);

CREATE MATERIALIZED VIEW {{ .database }}.{{ .table }}_agger
TO {{ .database }}.{{ .table }}
AS
SELECT
  toDate32(toStartOfDay(ts)) AS ts,
  ticker,
  if((anyIf(price, NOT hasAny(conditions, {{ .consMaybeLastConditions }})) as o)=0, any(price), o) AS open,
  max(price) AS high,
  min(price) AS low,
  if((anyLastIf(price, NOT hasAny(conditions, {{ .consMaybeLastConditions }})) as c)=0, anyLast(price), c) AS close,
  sumIf(size, update_volume) AS volume,
  sumIf(price * size, update_volume) / volume AS vwap,
  count() AS count
FROM {{ .database }}.trades
WHERE correction = 0 AND NOT hasAny(conditions, [12]) AND update
GROUP BY
  ticker,
  ts;
