CREATE TABLE IF NOT EXISTS
{{ .database }}.{{ .table }}{{ if .cluster }}_shard ON CLUSTER {{ .cluster }}{{ end }}
(
  ts     Date32,
  {{ .aggFields }}
)
ENGINE = {{ if .cluster }}
ReplicatedMergeTree(
	'/clickhouse/tables/{shard}/{database}/{{ .table }}',
	'{replica}'
)
{{ else }}
MergeTree()
{{ end }}
PARTITION BY toYear(ts)
ORDER BY (ticker, ts);

{{ if .cluster }}
CREATE TABLE IF NOT EXISTS
{{ .database }}.{{ .table }} ON CLUSTER {{ .cluster }}
AS {{ .database }}.{{ .table }}_shard
ENGINE = Distributed(
	'{cluster}',
	{{ .database }},
	{{ .table }}_shard,
	cityHash64(ticker)
);
{{ end }}

CREATE MATERIALIZED VIEW IF NOT EXISTS
{{ .database }}.{{ .table }}_agger
TO {{ .database }}.{{ .table }}
AS
WITH
	NOT hasAny(conditions, {{ .badPriceConditions }}) AND NOT hasAny(conditions, [12]) AS update_price,
	NOT hasAny(conditions, {{ .badVolumeConditions }}) AS update_volume
SELECT
	toDate32(toStartOfDay(ts)) AS ts,
	ticker,
	anyIf(price, update_price) AS open,
	maxIf(price, update_price) AS high,
	minIf(price, update_price) AS low,
	anyLastIf(price, update_price) AS close,
	sumIf(size, update_volume) AS volume,
	sumIf(price * size, update_volume) / volume AS vwap,
	count() AS count
FROM {{ .database }}.trades
WHERE correction = 0
GROUP BY
	ts,
	ticker;
