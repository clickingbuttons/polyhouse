CREATE TABLE {{ .database }}.{{ .table }} (
  ts     Date32,
  {{ .aggFields }}
)
ENGINE = AggregatingMergeTree
PARTITION BY toYear(ts)
ORDER BY (ticker, ts);

CREATE MATERIALIZED VIEW {{ .database }}.{{ .table }}_agger
TO {{ .database }}.{{ .table }}
AS
SELECT
  ticker,
  toDate32(toStartOfDay(ts)) AS ts,
  any(price) AS open,
  max(price) AS high,
  min(price) AS low,
  anyLast(price) AS close,
  sumIf(size, update_volume) AS volume,
  sumIf(price * size, update_volume) / volume AS vwap,
  count() AS count
FROM {{ .database }}.trades
WHERE correction = 0 AND update
GROUP BY
  ticker,
  ts;
