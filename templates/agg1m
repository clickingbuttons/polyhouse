CREATE TABLE IF NOT EXISTS {{ .database }}.{{ .table }} (
  ts     DateTime('America/New_York'),
  {{ .aggFields }}
)
ENGINE = MergeTree()
PARTITION BY toYYYYMM(ts)
ORDER BY (ticker, ts);

CREATE MATERIALIZED VIEW IF NOT EXISTS
{{ .database }}.{{ .table }}_agger
TO {{ .database }}.{{ .table }}
AS
WITH
	NOT hasAny(conditions, {{ .badPriceConditions }}) AS update_price,
	NOT hasAny(conditions, {{ .badVolumeConditions }}) AS update_volume
SELECT
  toStartOfMinute(ts) AS ts,
  ticker,
	anyIf(price, update_price) AS open,
	maxIf(price, update_price) AS high,
	minIf(price, update_price) AS low,
	anyLastIf(price, update_price) AS close,
	sumIf(size, update_volume) AS volume,
	sumIf(price * size, update_volume) / volume AS vwap,
	count() AS count
FROM {{ .database }}.trades
WHERE correction = 0
GROUP BY
  ticker,
  ts;
