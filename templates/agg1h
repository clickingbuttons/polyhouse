CREATE TABLE IF NOT EXISTS {{ .database }}.{{ .table }} (
  ts     DateTime,
  {{ .aggFields }}
)
ENGINE = MergeTree()
PARTITION BY toYear(ts)
ORDER BY (ticker, ts);

CREATE MATERIALIZED VIEW IF NOT EXISTS
{{ .database }}.{{ .table }}_agger
TO {{ .database }}.{{ .table }}
AS
SELECT
	toDateTime(toStartOfHour(ts)) AS ts,
	ticker,
	any(open) AS open,
	max(high) AS high,
	min(low) AS low,
	anyLast(close) AS close,
	sum(agg1m.volume) AS volume,
	sum(agg1m.vwap * agg1m.volume) / sum(agg1m.volume) AS vwap,
	sum(agg1m.count) AS count
FROM {{ .database }}.agg1m
GROUP BY
	ts,
	ticker;
